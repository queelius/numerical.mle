# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working
with code in this repository.

## Package Overview

`numerical.mle` is an R package providing numerical maximum likelihood
estimation (MLE) solvers. The package implements various optimization
algorithms to find MLEs from log-likelihood functions. This is early
alpha software that was extracted from the `algebraic.mle` package.

Key dependency: This package builds on `algebraic.mle` for the core
`mle` object representation.

**Recent Refactoring (2025-11-24)**: The package API has been completely
refactored for consistency, composability, and type safety. See
`REFACTORING_SUMMARY.md` for details. Both the new and legacy APIs are
currently available.

## Development Commands

### Building and Documentation

- **Build package**: `R CMD build .` or in R:
  [`devtools::build()`](https://devtools.r-lib.org/reference/build.html)
- **Install locally**:
  [`devtools::install()`](https://devtools.r-lib.org/reference/install.html)
  or `devtools::install_github("queelius/numerical.mle")`
- **Load for development**:
  [`devtools::load_all()`](https://devtools.r-lib.org/reference/load_all.html)
- **Generate documentation**:
  [`devtools::document()`](https://devtools.r-lib.org/reference/document.html)
  (runs roxygen2)
- **Build README**: Knit `README.Rmd` to generate `README.md`
- **Build pkgdown site**:
  [`pkgdown::build_site()`](https://pkgdown.r-lib.org/reference/build_site.html)

### Testing

- **Run all tests**:
  [`devtools::test()`](https://devtools.r-lib.org/reference/test.html)
  or `testthat::test_dir("tests/testthat")`
- **Run specific test file**:
  `testthat::test_file("tests/testthat/test-*.R")`
- **Check package**:
  [`devtools::check()`](https://devtools.r-lib.org/reference/check.html)
  (comprehensive R CMD check)
- **Test coverage**:
  [`covr::package_coverage()`](http://covr.r-lib.org/reference/package_coverage.md)
  to analyze test coverage
- **Note**: Tests use a mock
  [`algebraic.mle::mle()`](https://queelius.github.io/algebraic.mle/reference/mle.html)
  constructor (in `tests/testthat/helper-mock-mle.R`) so tests can run
  without the full algebraic.mle package installed

### Code Quality

- **Lint code**: Use `lintr::lint_package()` for style checking
- **Check NAMESPACE**: Auto-generated by roxygen2 - never edit manually

## New API (Refactored - Recommended)

The package now features a refactored API with these key improvements:

### Configuration Objects (Type-Safe)

- [`mle_config()`](https://queelius.github.io/numerical.mle/reference/mle_config.md) -
  Base configuration for convergence criteria
- [`mle_config_gradient()`](https://queelius.github.io/numerical.mle/reference/mle_config_gradient.md) -
  Adds learning rate for gradient methods
- [`mle_config_linesearch()`](https://queelius.github.io/numerical.mle/reference/mle_config_linesearch.md) -
  Adds backtracking line search parameters
- [`mle_constraint()`](https://queelius.github.io/numerical.mle/reference/mle_constraint.md) -
  Domain constraints (support + projection functions)

### Unified Solver Interface

All solvers follow: `solver(loglike, ..., theta0, config, constraint)`

**Core Solvers**: -
`mle_gradient_ascent(loglike, score, theta0, config, constraint)` -
`mle_newton_raphson(loglike, score, fisher, theta0, config, constraint, inverted)`

**Meta-Solvers**: -
`mle_grid_search(loglike, lower, upper, grid_size, refine_solver, ...)` -
`mle_random_restart(loglike, solver, theta0_sampler, n_trials, ...)`

**Convenience Wrappers**: -
[`mle_grad()`](https://queelius.github.io/numerical.mle/reference/mle_grad.md) -
Quick gradient ascent with sensible defaults -
[`mle_nr()`](https://queelius.github.io/numerical.mle/reference/mle_nr.md) -
Quick Newton-Raphson with sensible defaults

### Function Transformers (Composable)

- `with_subsampling(loglike, data, subsample_size, replace)` -
  Stochastic gradient
- `with_penalty(loglike, penalty, lambda)` - Regularization
  (L1/L2/elastic net)
- [`penalty_l1()`](https://queelius.github.io/numerical.mle/reference/penalty_l1.md),
  [`penalty_l2()`](https://queelius.github.io/numerical.mle/reference/penalty_l2.md),
  [`penalty_elastic_net()`](https://queelius.github.io/numerical.mle/reference/penalty_elastic_net.md) -
  Penalty functions
- `compose(...)` - Compose multiple transformations

### Example Usage

``` r
# Simple gradient ascent
result <- mle_grad(loglike, score, theta0 = c(0, 1))

# With line search and constraints
config <- mle_config_linesearch(max_step = 1.0, max_iter = 200)
constraint <- mle_constraint(
  support = function(theta) all(theta > 0),
  project = function(theta) pmax(theta, 1e-8)
)
result <- mle_gradient_ascent(loglike, score, theta0, config, constraint)

# Composed transformations
loglike_transformed <- loglike %>%
  with_subsampling(data, subsample_size = 100) %>%
  with_penalty(penalty_l2(), lambda = 0.1)
result <- mle_grad(loglike_transformed, score, theta0)
```

## Architecture

### Core Object Model

All numerical MLE solvers return `mle_numerical` objects, which extend
the base `mle` class from `algebraic.mle`. The `mle_numerical` class
adds: - `iter`: number of iterations taken - `converged`: logical
indicating convergence - `options`: configuration used during
optimization

### Solver Hierarchy

The package implements a layered architecture:

1.  **Base Layer** (`R/numerical.mle.R`, `R/generic_functions.R`):
    - [`mle_numerical()`](https://queelius.github.io/numerical.mle/reference/mle_numerical.md):
      Constructor for numerical MLE objects
    - Generic methods:
      [`is_converged()`](https://queelius.github.io/numerical.mle/reference/is_converged.md),
      [`num_iterations()`](https://queelius.github.io/numerical.mle/reference/num_iterations.md),
      [`is_mle_numerical()`](https://queelius.github.io/numerical.mle/reference/is_mle_numerical.md)
2.  **Utility Layer** (`R/utils.R`):
    - `backtracking_line_search()`: Adaptive step size for gradient
      methods
    - `clip_step()`: Step size limiting
    - Various optimization utilities (grad_descent, local_minimize_ls,
      etc.)
3.  **Core Solver** (`R/mle_local_search.R`):
    - `mle_local_search()`: Generalized local search framework used by
      most solvers
    - Configurable via `options` list with parameters for convergence,
      step size, line search, debugging, etc.
    - Supports projection functions for constrained optimization
    - Optional path tracing for visualization
4.  **Specialized Solvers**:
    - [`mle_gradient_ascent()`](https://queelius.github.io/numerical.mle/reference/mle_gradient_ascent.md):
      Gradient-based optimization (uses score function)
    - [`mle_newton_raphson()`](https://queelius.github.io/numerical.mle/reference/mle_newton_raphson.md):
      Second-order Newton-Raphson (uses score and Fisher information)
    - [`mle_grid_search()`](https://queelius.github.io/numerical.mle/reference/mle_grid_search.md):
      Exhaustive grid search over parameter space
    - `mle_random_search()`: Stochastic search methods
    - [`mle_random_restart()`](https://queelius.github.io/numerical.mle/reference/mle_random_restart.md):
      Multiple random initializations
    - `mle_sim_anneal()`: Simulated annealing for global optimization
    - `mle_optim()`: Wrapper for base R
      [`optim()`](https://rdrr.io/r/stats/optim.html) that returns `mle`
      objects

### Key Design Patterns

**Function Adapters**: The package provides adapters for log-likelihood
functions: - `stochastic_loglike()`: Subsample observations for large
datasets (enables stochastic gradient ascent) - `penalize_loglike()`:
Add penalty terms for constrained optimization

**Options Pattern**: Most solvers accept an `options` list for
configuration. Common options include: - `sup`: Support constraint
function (domain checking) - `proj`: Projection function to enforce
constraints - `loglike`: Log-likelihood function (required for line
search) - `eta`: Learning rate/step size - `max_iter`: Maximum
iterations - `abs_tol`/`rel_tol`: Convergence tolerances - `debug`:
Enable debugging output - `trace`: Store optimization path -
`line_search`: Enable backtracking line search

**Direction Functions**: Local search methods accept a `dir` function
that computes a promising search direction: - Gradient ascent uses
`dir = score` (gradient of log-likelihood) - Newton-Raphson uses
`dir = function(x) covar(x) %*% score(x)` (FIM-weighted gradient)

### File Organization

- `R/mle_*.R`: Individual solver implementations
- `R/generic_functions.R`: Generic methods for `mle_numerical` objects
- `R/utils.R`: Low-level optimization utilities
- `R/numerical.mle.R`: Package documentation
- `man/*.Rd`: Auto-generated documentation (via roxygen2 - never edit
  manually)
- `tests/testthat/`: Test suite with 53+ test cases across 6 test files
- `tests/testthat/helper-mock-mle.R`: Mock implementation of
  algebraic.mle::mle for testing
- `vignettes/`: Extended examples and tutorials
- `fixing/`: Development/experimental code (not part of package, not
  tested)
- `docs/`: Generated pkgdown site (build with
  [`pkgdown::build_site()`](https://pkgdown.r-lib.org/reference/build_site.html))

## Important Notes

### Development Status

- This is **alpha software** - extracted from `algebraic.mle` but not
  all functions are fully tested
- **Tested solvers**: `mle_gradient_ascent`, `mle_newton_raphson`,
  `mle_local_search`, and utility functions
- **Untested solvers**: `mle_grid_search`, `mle_random_search`,
  `mle_random_restart`, `mle_sim_anneal`, `mle_optim`
- Code in `fixing/` directory is experimental and should not be relied
  upon

### Usage Guidelines

- Always provide initial guesses (`theta0`) that are in the support of
  the log-likelihood
- For constrained optimization, use the `sup` (support checker) and
  `proj` (projection) options
- Newton-Raphson requires both score and Fisher information matrix
  functions (or inverted FIM)
- Grid search can be combined with local search via the `mle_solver`
  option

### Dependencies

- **Required**: The package expects `algebraic.mle` to be installed for
  the base `mle` class
- For development/testing, algebraic.mle is mocked in
  `tests/testthat/helper-mock-mle.R`
- Other dependencies: `MASS`, `numDeriv`, `stats`, `mvtnorm`, `CDFt`,
  `zoo`, `dplyr`

### Test Suite

- 53+ test cases covering core functionality
- All unit tests passing for tested components
- Some integration tests may need parameter tuning for convergence
- Run
  [`devtools::test()`](https://devtools.r-lib.org/reference/test.html)
  before committing changes
- See `TESTING_SUMMARY.md` for detailed test coverage analysis
